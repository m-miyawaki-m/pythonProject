# **基本設計**

## **1. 処理の全体フロー**

1. **XML ファイルの読み込み**

   - `xml.etree.ElementTree`を使用して MyBatis XML ファイルをパース。
   - タグごとに SQL 文と属性情報を収集。

2. **SQL 解析**

   - `sqlparse`を利用して、SQL 文を解析。
   - テーブル名、カラム名、WHERE 句条件を抽出。
   - JOIN 句やサブクエリ、エイリアスを含む複雑な SQL 文にも対応。

3. **`<sql>`タグと`<include>`タグの展開**

   - `<sql>`タグの`id`属性をキーに SQL 片を収集。
   - `<include>`タグの`refid`属性を解決し、元の SQL 文に展開。
   - 展開後の WHERE 句条件を解析し、出典情報を記録。

4. **データ整理**

   - タグ、ID、テーブル、カラム、条件式、出典情報を 1 行ごとに記録。

5. **CSV 出力**
   - 整理されたデータを CSV 形式で保存。

---

## **2. 各処理の詳細**

### **2.1 XML ファイルの読み込み**

- **対象タグ**：

  - `<select>`, `<insert>`, `<update>`, `<delete>`：SQL 文を直接解析。
  - `<sql>`：SQL 片を収集（条件式、カラム定義など）。
  - `<include>`：参照先（`refid`）を解決し、展開。

- **処理内容**：
  - `id`属性と SQL 文を取得。
  - タグごとに解析対象として登録。

---

### **2.2 SQL 解析**

- **利用技術**：

  - `sqlparse`を使用して SQL 文をトークン化し解析。

- **解析項目**：
  - **テーブル名**：
    - `FROM`句や`JOIN`句を解析して抽出。
    - エイリアスを解決。
  - **カラム名**：
    - SELECT 句や WHERE 句、INSERT、UPDATE 文のカラムを抽出。
    - エイリアスを解決して元のカラム名を取得。
  - **WHERE 句条件**：
    - 条件式をリスト化。
    - 複数条件やパラメータ（`#{param}`）に対応。

---

### **2.3 `<sql>`タグと`<include>`タグの展開**

- **`<sql>`タグ**：

  - `id`属性をキーとして SQL 片を辞書形式で保存。
  - 展開時に再帰的に解析。

- **`<include>`タグ**：

  - `refid`属性で指定された`<sql>`タグを解決し、展開。
  - 展開された内容を WHERE 句条件として記録。

- **出典情報**：
  - 展開された SQL 片に`<sql>`タグや`<include>`タグの ID を記録。

---

### **2.4 データ整理**

- **1 行 1 データ**：

  - タグ、ID、テーブル名、カラム名、条件式、条件の出典を 1 行ごとに記録。

- **例**：
  ```python
  [
      {"tag": "select", "id": "findAll", "table": "USER_DATA", "column": "id", "condition": "u.sex = #{sex}", "source": "commonCondition"},
      {"tag": "sql", "id": "commonCondition", "table": "USER_DATA", "column": "sex", "condition": "u.sex = #{sex}", "source": None}
  ]
  ```

---

### **2.5 CSV 出力**

- **出力仕様**：

  - カラム順：
    - タグ、ID、テーブル名、カラム名、条件式、条件の出典。
  - 行単位：
    - 各テーブル・カラムごとに行を分割。

- **使用技術**：
  - `csv`モジュールでファイル保存。

---

## **3. 制約と考慮事項**

1. **SQL 文の構造**：

   - サブクエリやネストされた`<include>`タグに対応。
   - JOIN 句やエイリアス解決。

2. **展開順序**：

   - `<sql>`タグと`<include>`タグを再帰的に展開し、最終的な SQL 文を解析。

3. **汎用性**：
   - 今後の MyBatis タグ追加にも対応可能な設計。

---
